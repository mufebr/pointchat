<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PointChat ‚Äî Online Conversation Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#6ee7b7; --accent-2:#60a5fa;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:
      radial-gradient(800px 400px at 10% 10%, rgba(99,102,241,0.08), transparent 8%),
      radial-gradient(700px 400px at 90% 90%, rgba(34,211,238,0.03), transparent 8%),
      var(--bg);
    color:#e6eef8;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:28px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

   .app {
  width: 100%;             /* ocupa a largura dispon√≠vel */
  max-width: 1100px;       /* limite para telas grandes */
  height: 90vh;            /* ocupa quase toda a altura da tela */
  max-height: 760px;       /* limite para telas grandes */
  display: grid;
  grid-template-columns: 360px 1fr; /* sidebar + chat */
  gap: 18px;
  align-items: stretch;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(2,6,23,0.6);
}

/* Mobile */
@media (max-width: 960px) {
  .app {
    grid-template-columns: 1fr; /* transforma em 1 coluna */
    height: 92vh;
    max-height: unset;
  }
  .panel {
    order: 2; /* move o painel para baixo do chat */
  }
}

  /* left sidebar */
  .panel {
    background:linear-gradient(180deg,var(--card),rgba(6,9,18,0.7));
    border-radius:14px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:44px;height:44px;border-radius:10px;
    background:linear-gradient(135deg,var(--accent-2),var(--accent));
    display:grid;place-items:center;font-weight:700;color:#02203a;font-size:20px;
    box-shadow: 0 6px 18px rgba(60,90,255,0.12);
  }
  h1{font-size:16px;margin:0}
  .muted{color:var(--muted);font-size:13px;margin-top:4px}

  .controls{display:flex;flex-direction:column;gap:8px;margin-top:6px}
  button, .select{
    background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.06);
    padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;
  }
  .small{font-size:13px;padding:8px;border-radius:8px}
  .row{display:flex;gap:8px;align-items:center}

  .meta{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
  .muted-pill{background:var(--glass);padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}

  .themes{display:flex;gap:8px}
  .theme-btn{width:44px;height:34px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;display:inline-grid;place-items:center}

  /* right (chat area) */
  .chat {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
    border-radius:14px;padding:14px;display:flex;flex-direction:column;overflow:hidden;
  }

  .chat-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
  .partner{display:flex;gap:12px;align-items:center}
  .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#f97316,#f43f5e);display:grid;place-items:center;font-weight:700}
  .status{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center}

  .messages{
    flex:1; overflow:auto; padding:18px; display:flex;flex-direction:column;gap:10px;
    background-image: linear-gradient(transparent 0%, rgba(255,255,255,0.01) 100%);
  }
  .msg{max-width:78%;padding:10px 12px;border-radius:12px;position:relative}
  .msg.me{align-self:flex-end;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#02203a}
  .msg.other{align-self:flex-start;background:rgba(255,255,255,0.03);color:var(--muted)}
  .meta-time{font-size:11px;color:rgba(255,255,255,0.6);margin-top:6px;text-align:right}

  .compose{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.03);align-items:center}
  .input{
    background:transparent;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:12px;flex:1;color:inherit;
    min-height:44px;resize:none;font-size:14px
  }
  .send{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#02203a;font-weight:700;cursor:pointer}

  .tiny{font-size:12px;color:var(--muted)}
  .center{display:grid;place-items:center;height:100%}
  .hint{font-size:13px;color:var(--muted);text-align:center;padding:8px 12px}

  /* message image */
  .msg img{max-width:280px;border-radius:8px;display:block;margin-top:8px}

  /* responsive */
  @media (max-width:960px){
    .app{grid-template-columns: 1fr; height:92vh}
    .panel{order:2}
  }

  /* alternate light theme (applied via .light on body) */
  body.light{
    --bg:#f6fafc; --card:#ffffff; --muted:#475569; --accent:#06b6d4; --accent-2:#7c3aed;
    color:#0b1220;
    background:linear-gradient(180deg,#e6f7ff,#fff);
  }
  body.light .logo{color:#fff}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Anon online chat">
  <aside class="panel" aria-label="controls">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1></h1>
        <div class="muted">conversations ‚Äî browser-only demo</div>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <button id="btn-random" class="small">Join random</button>
        <button id="btn-share" class="small">Share link</button>
      </div>

      <div class="row">
        <input id="roomInput" class="small" placeholder="Or enter a room name" />
        <button id="btn-join" class="small">Join</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <div class="muted-pill" id="roomLabel">Room: <span id="roomName">‚Äî</span></div>
        <div class="muted-pill" id="partnerLabel">Partner: <span id="partnerStatus">none</span></div>
      </div>

      <div style="margin-top:6px">
        <div class="tiny">Layout / theme</div>
        <div class="themes" style="margin-top:6px">
          <div class="theme-btn" id="themeDefault" title="Dark (default)">üåô</div>
          <div class="theme-btn" id="themeLight" title="Light theme">‚òÄÔ∏è</div>
        </div>
      </div>

      <div style="margin-top:8px">
        <div class="tiny">Extras</div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="btn-simulate" class="small">Simulate bot</button>
          <button id="btn-clear" class="small">Clear chat</button>
        </div>
      </div>

      <div style="margin-top:auto">
        <div class="tiny">How it works</div>
        <div class="muted" style="margin-top:6px">
          - Uses your browser to broadcast messages between tabs using the same room name.<br>
          - No server: share the same file and room name on the same machine or use the simulated bot.
        </div>
      </div>
    </div>
  </aside>

  <main class="chat" aria-live="polite">
    <div class="chat-header">
      <div class="partner">
        <div class="avatar" id="avatar">You</div>
        <div>
          <div id="partnerName"></div>
          <div class="status" id="statusText">Not connected</div>
        </div>
      </div>
      <div class="actions">
        <button id="btn-end" class="small">End chat</button>
      </div>
    </div>

    <div class="messages" id="messages" role="log" aria-atomic="false">
      <div class="center hint" id="welcome">
        <div style="font-weight:700;font-size:18px">Welcome to VortexChat</div>
        <div class="muted" style="margin-top:6px">Click "Join random" to start or enter a room name and open the same file in another tab.</div>
      </div>
    </div>

    <div class="compose">
      <input id="fileInput" type="file" accept="image/*" style="display:none">
      <button id="btn-image" class="small" title="Send image">üñºÔ∏è</button>
      <textarea id="input" class="input" placeholder="Say hi ‚Äî press Enter to send" rows="1"></textarea>
      <button id="btn-send" class="send">Send</button>
    </div>
  </main>
</div>

<script>
/* ======= Utilities ======= */
function $(s){return document.querySelector(s)}
function elt(tag, cls='', txt=''){const e=document.createElement(tag); if(cls) e.className=cls; if(txt) e.textContent=txt; return e}
function fmtTime(d=new Date()){return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}

/* ======= State ======= */
let room = null;
let bc = null; // BroadcastChannel
let connectedPartners = 0;
let myId = 'u'+Math.random().toString(36).slice(2,9);
let partnerId = null;
let simBotActive = false;
let typingTimer = null;

/* ======= UI refs ======= */
const roomLabel = $('#roomName');
const partnerLabel = $('#partnerStatus');
const statusText = $('#statusText');
const messages = $('#messages');
const input = $('#input');
const btnSend = $('#btn-send');
const btnRandom = $('#btn-random');
const btnJoin = $('#btn-join');
const btnShare = $('#btn-share');
const btnEnd = $('#btn-end');
const roomInput = $('#roomInput');
const btnImage = $('#btn-image');
const fileInput = $('#fileInput');
const welcome = $('#welcome');
const avatar = $('#avatar');
const partnerNameEl = $('#partnerName');
const btnSim = $('#btn-simulate');
const btnClear = $('#btn-clear');

/* ======= Message rendering ======= */
function addMessage(kind, text, meta={}){
  welcome?.remove();
  const m = elt('div','msg '+(kind==='me'?'me':'other'));
  if(meta.name){
    const n = elt('div','tiny'); n.textContent = meta.name; n.style.opacity = '0.9'; n.style.marginBottom='6px';
    m.appendChild(n);
  }
  if(meta.image){
    const img = document.createElement('img'); img.src = meta.image; m.appendChild(img);
  }
  const body = elt('div','',''); body.innerHTML = escapeHtml(text).replace(/\n/g,'<br>');
  m.appendChild(body);
  const t = elt('div','meta-time', fmtTime(meta.date? new Date(meta.date): undefined));
  m.appendChild(t);
  messages.appendChild(m);
  messages.scrollTop = messages.scrollHeight;
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[c]); }

/* ======= BroadcastChannel logic (no-server messaging within same-origin) ======= */
function joinRoom(name){
  leaveRoom();
  room = name || ('room-'+Math.random().toString(36).slice(2,7));
  roomLabel.textContent = room;
  history.replaceState(null,'', '#'+room);
  bc = new BroadcastChannel('anonchat-'+room);
  bc.onmessage = handleBC;
  // announce presence
  bc.postMessage({type:'hello', from:myId});
  statusText.textContent = 'Searching for partner...';
  partnerLabel.textContent = 'none';
  partnerNameEl.textContent = '';
  avatar.textContent = 'You';
  connectedPartners = 0;
  simBotActive = false;

  // If no partner quickly, offer simulated bot after timeout
  setTimeout(()=>{
    if(connectedPartners===0){
      statusText.textContent = 'No partners yet ‚Äî you can open the same link in another tab or use simulated bot.';
    }
  },900);
}

function leaveRoom(){
  if(bc){ try{ bc.postMessage({type:'leave', from:myId}); bc.close(); } catch(e){} bc=null; }
  room=null;
  roomLabel.textContent = '‚Äî';
  partnerLabel.textContent='none';
  statusText.textContent='Not connected';
  partnerNameEl.textContent='';
  avatar.textContent='You';
}

function handleBC(ev){
  const msg = ev.data;
  if(!msg || msg.from===myId) return; // ignore my own
  switch(msg.type){
    case 'hello':
      // someone joined: reply with welcome
      connectedPartners++;
      partnerId = msg.from;
      partnerLabel.textContent = 'connected';
      statusText.textContent = 'Connected';
      partnerNameEl.textContent = 'Partner';
      avatar.textContent = 'P?';
      // tell them who we are
      bc.postMessage({type:'welcome', from:myId});
      break;
    case 'welcome':
      connectedPartners++;
      partnerId = msg.from;
      partnerLabel.textContent = 'connected';
      statusText.textContent = 'Connected';
      partnerNameEl.textContent = 'Partner';
      avatar.textContent = 'P?';
      break;
    case 'leave':
      connectedPartners = Math.max(0, connectedPartners-1);
      partnerLabel.textContent = connectedPartners>0 ? 'connected' : 'none';
      if(connectedPartners===0){
        statusText.textContent = 'Partner left';
        partnerNameEl.textContent = '';
        avatar.textContent='You';
      }
      break;
    case 'typing':
      showTypingIndicator(true);
      clearTimeout(typingTimer);
      typingTimer = setTimeout(()=>showTypingIndicator(false), 1200);
      break;
    case 'msg':
      showTypingIndicator(false);
      addMessage('other', msg.text, {date: msg.date, name:'Partner', image: msg.image});
      break;
    default: break;
  }
}

/* ======= typing indicator ======= */
let typingIndicatorEl = null;
function showTypingIndicator(show){
  if(show){
    if(!typingIndicatorEl){
      typingIndicatorEl = elt('div','tiny'); typingIndicatorEl.textContent='Partner is typing...';
      messages.appendChild(typingIndicatorEl);
      messages.scrollTop = messages.scrollHeight;
    }
  } else {
    if(typingIndicatorEl){ typingIndicatorEl.remove(); typingIndicatorEl = null; }
  }
}

/* ======= send message ======= */
function sendMessage(text, image=null){
  if(!text && !image) return;
  const payload = {
    type:'msg',
    from:myId,
    date: new Date().toISOString(),
    text: text || '',
    image: image || null
  };
  // local render
  addMessage('me', payload.text, {date: payload.date, name:'You', image: payload.image});
  // broadcast
  if(bc) bc.postMessage(payload);
}

/* ======= UI event wiring ======= */
btnRandom.onclick = ()=> joinRoom('room-'+Math.random().toString(36).slice(2,6));
btnJoin.onclick = ()=> {
  const n = (roomInput.value || '').trim();
  if(!n) { alert('Enter a room name or use "Join random".'); return; }
  joinRoom(n);
};
btnShare.onclick = ()=>{
  if(!room) joinRoom('room-'+Math.random().toString(36).slice(2,6));
  const url = location.href.split('#')[0] + '#'+room;
  navigator.clipboard?.writeText(url).then(()=>{ alert('Room link copied: open same link in another tab to connect.'); }).catch(()=>{ prompt('Copy this link:', url); });
};
btnEnd.onclick = ()=>{
  if(confirm('End this chat?')){ leaveRoom(); messages.innerHTML = '<div class="center hint">Chat ended. Join another room to start again.</div>'; }
};
btnClear.onclick = ()=> { messages.innerHTML=''; messages.appendChild(welcome); }

btnSim.onclick = ()=>{
  if(simBotActive){ simBotActive=false; btnSim.textContent='Simulate bot'; messages.innerHTML=''; messages.appendChild(welcome); return; }
  simBotActive=true;
  if(!room) joinRoom('bot-'+Math.random().toString(36).slice(2,6));
  partnerLabel.textContent='bot';
  statusText.textContent='Connected to bot';
  partnerNameEl.textContent='ChatBot';
  avatar.textContent='ü§ñ';
  messages.innerHTML='';
  runSimulationBot();
  btnSim.textContent='Stop bot';
};

btnImage.onclick = ()=> fileInput.click();
fileInput.onchange = async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const data = await fileToDataURL(f);
  sendMessage('', data);
  fileInput.value='';
};

input.addEventListener('input', ()=>{
  if(bc) bc.postMessage({type:'typing', from:myId});
});

input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    const v = input.value.trim();
    sendMessage(v);
    input.value='';
  }
});

btnSend.onclick = ()=> { const v = input.value.trim(); sendMessage(v); input.value=''; }

/* ======= image helper ======= */
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* ======= simulate bot (simple) ======= */
const botReplies = [
  "Hey! Nice to meet you. Where are you chatting from?",
  "Cool. What's your favorite game?",
  "I love music ‚Äî what song have you had on repeat recently?",
  "Haha interesting! Tell me more.",
  "Nice. Do you build things online or play a lot?",
  "That's awesome. Any projects you're proud of?"
];

function runSimulationBot(){
  // very simple conversation flow
  setTimeout(()=> addMessage('other','Hi ‚Äî I\'m a friendly bot. Say anything to start!', {date: new Date().toISOString(), name:'ChatBot'}), 700);
  // echo responses on user messages
  const origSend = sendMessage;
  window.sendMessage = function(text, image){
    origSend(text, image);
    if(!simBotActive) return;
    // schedule bot reply
    const reply = botReplies[Math.floor(Math.random()*botReplies.length)];
    setTimeout(()=> addMessage('other', reply, {date: new Date().toISOString(), name:'ChatBot'}), 900 + Math.random()*1200);
  };
}

/* ======= theme switching ======= */
$('#themeLight').onclick = ()=> document.body.classList.add('light');
$('#themeDefault').onclick = ()=> document.body.classList.remove('light');

/* ======= history room from hash ======= */
(function initFromHash(){
  const h = location.hash.replace('#','').trim();
  if(h) joinRoom(h);
})();

/* ======= graceful unload ======= */
window.addEventListener('beforeunload', ()=> { if(bc) try{ bc.postMessage({type:'leave', from:myId}); }catch(e){} });

/* ======= accessibility: focus send via ctrl+enter? already Enter handled. ======= */

/* ======= small demo: if user opens two tabs and wants to connect: instruction ======= */
(function maybeShowHint(){
  // nothing ‚Äî welcome already instructs how to connect
})();

</script>
</body>
</html>
